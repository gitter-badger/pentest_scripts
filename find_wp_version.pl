#!/usr/bin/perl
# Author: Sanjeev Jaiswal (Jassi)
# Visit us: http://www.aliencoders.org/
# Description: Find WordPress Version without login
# There are various ways to find WP Version.
# We will use all possible methods as stated below:
# 1. Header response to check generator tag
# 2. readme.html page of a site like aliencoders.org or shoutmeloud.com
# 3. View source of wp-login.php and fine ?ver= in best possible manner
# like labnol.org or even of needrom.com which is not detected as WP by many add-ons
 
use strict;
use warnings;
use WWW::Mechanize;
use LWP::UserAgent;
my $url = $ARGV[0] || die "Should pass site name $0 <sitename>\n";
$url = "http://".$url unless($url =~ m/^http/);
 
print "# Checking Response Header for generator tag\n";
my $meta_version = check_response_header( $url );
print_version( $url, $meta_version) if $meta_version;
 
print "# Checking readme.html source for the version\n";
my $readme_version = get_site_content( "$url/readme.html" );
print_version( $url, $readme_version ) if $readme_version;
 
print "# Checking wp-login.php source page for ?ver= instances \n";
my $login_ver = get_site_content( "$url/wp-login.php" );
print_version( $url, $login_ver ) if ( $login_ver );
 
 
sub init_mech{
  return WWW::Mechanize->new();
}
 
sub get_site_content{
  my $url = shift;
  my $mech = init_mech();
  eval { $mech->get( $url ); };
  return 0 if $@;
 
  my $status = $mech->status( $url );
  return 0 unless ($status == 200);
 
  my $content = $mech->content();
  my $version = 0;
  if($url =~ /readme/){
    ($version) = $content =~ /version\s+(\d+\.\d+(?:\.\d+)?)/mig;
  }
  else {
    ($version) = $content =~ m#wp-(?:admin|content|includes)/(?!plugins|js).*?ver=(\d+\.\d+(?:\.\d+)?(?:[-\w\.]+)?)#mig;
  }
  return $version if($version);
  return 0;
}
 
sub check_response_header{
  # Using LWP::UserAgent
  my $ua = LWP::UserAgent->new();
  $ua->timeout(10);
  $ua->agent(\'Mozilla/5.0\');
 
  # connect and get
  my $response = $ua->get($url);
  my $string = $response->headers()->as_string;
  my ( $generator ) = $string =~ m/X-Meta-Generator:\s+(.*)/gim;
 
  return $generator if($generator);
  return 0;
}
 
sub print_version
{
  my ($url, $version) = @_;
  print "$url has $version installed\n";
  exit;
}
